# Documentação da Aplicação NestJS com TypeORM e PostgreSQL

## Índice

- [Introdução](#introdução)
- [Pré-requisitos](#pré-requisitos)
- [Configuração do Ambiente](#configuração-do-ambiente)
- [Instalação das Dependências](#instalação-das-dependências)
- [Criação do Projeto NestJS](#criação-do-projeto-nestjs)
- [Estrutura do Projeto](#estrutura-do-projeto)
- [Implementação do CRUD](#implementação-do-crud)
   - [Modelo de Dados com TypeORM](#modelo-de-dados-com-typeorm)
   - [Atualização do Serviço e Controlador](#atualização-do-serviço-e-controlador)
- [Testando a Aplicação](#testando-a-aplicação)
- [Exercício](#exercício)
- [Referências](#referências)

## Introdução

Esta documentação orienta sobre como configurar uma aplicação NestJS com TypeORM para conectar a um banco de dados PostgreSQL, e como implementar funcionalidades CRUD básicas.

## Pré-requisitos

Antes de começar, você deve ter:

1. **Docker** instalado e em execução.
2. **Node.js** instalado.
3. **Nest CLI** instalado globalmente.

## Configuração do Ambiente

### 1. Configurar o PostgreSQL usando Docker

1. Certifique-se de que o Docker está instalado e em execução na sua máquina.

2. Execute o seguinte comando para baixar a imagem do PostgreSQL e iniciar um contêiner:

   ```bash
   docker run --name postgres-container -e POSTGRES_PASSWORD=root -e POSTGRES_DB=aula_web2 -p 5432:5432 -d postgres:latest
   ```

3. Acesse o container do PostgreSQL:

   ```bash
   docker exec -it postgres-container psql -U postgres
   ```

   Isso abrirá o terminal psql dentro do container e pedirá a senha de `postgres` que você definiu (neste caso, `root`).

## Instalação das Dependências

### 1. Instalar o Node.js

Certifique-se de ter o Node.js instalado. Baixe a versão mais recente do [site oficial do Node.js](https://nodejs.org/).

### 2. Instalar o Nest CLI

O Nest CLI facilita a criação e o gerenciamento de projetos NestJS. Para instalá-lo, execute o seguinte comando:

   ```bash
   npm install -g @nestjs/cli
   ```

## Criação do Projeto NestJS

### 1. Criar um Novo Projeto

Use o Nest CLI para criar um novo projeto:

   ```bash
   nest new projeto-nest
   ```

### 2. Navegar até o Diretório do Projeto

Após a criação, vá até o diretório do projeto:

   ```bash
   cd projeto-nest
   ```

### 3. Iniciar o Servidor de Desenvolvimento

Para iniciar o servidor, execute:

   ```bash
   npm run start:dev
   ```

## Estrutura do Projeto

A estrutura básica do projeto NestJS inclui:

- `src/` - Diretório principal do código-fonte.
- `main.ts` - Ponto de entrada da aplicação.
- `app.module.ts` - Módulo raiz da aplicação.
- `app.controller.ts` e `app.service.ts` - Exemplos de controlador e serviço.
- `contacts/` - Diretório do módulo de contatos, incluindo o controlador, serviço e entidade.

## Implementação do CRUD

### 1. Modelo de Dados com TypeORM

#### 1. Instalar as Dependências

Instale o TypeORM e o driver PostgreSQL:

   ```bash
   npm install @nestjs/typeorm typeorm pg
   ```

#### 2. Configurar o TypeORM

No arquivo `app.module.ts`, configure o TypeORM para conectar ao banco de dados PostgreSQL:

```typescript
// src/app.module.ts
import { Module } from '@nestjs/common';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { ContactsModule } from './contacts/contacts.module';
import { TypeOrmModule } from '@nestjs/typeorm';

@Module({
  imports: [
    TypeOrmModule.forRoot({
      type: 'postgres',
      host: 'localhost',
      port: 5432,
      username: 'postgres',
      password: 'root',
      database: 'aula_web2',
      entities: [__dirname + '/**/*.entity{.ts,.js}'],
      synchronize: true, // Atenção: Use apenas em desenvolvimento
    }),
    ContactsModule
  ],
  controllers: [AppController],
  providers: [AppService],
})
export class AppModule {}
```

#### 3. Criar uma Entidade Contact

Crie uma nova entidade chamada `Contact`:

```typescript
// src/contacts/contacts.entity.ts
import { Entity, Column, PrimaryGeneratedColumn } from 'typeorm';

@Entity()
export class Contact {
  @PrimaryGeneratedColumn()
  id: number;

  @Column({ type: 'varchar', length: 100 })
  name: string;

  @Column({ type: 'varchar', length: 150, unique: true })
  email: string;

  @Column({ type: 'varchar', length: 255 })
  phone: string;

  @Column({ type: 'date', nullable: true })
  birthDate?: Date;
}
```

#### 4. Atualizar o Módulo Contacts

Certifique-se de que o módulo `ContactsModule` esteja configurado para usar o TypeORM e a nova entidade:

```typescript
// src/contacts/contacts.module.ts
import { Module } from '@nestjs/common';
import { ContactsService } from './contacts.service';
import { ContactsController } from './contacts.controller';
import { TypeOrmModule } from '@nestjs/typeorm';
import { Contact } from './contacts.entity';

@Module({
  imports: [TypeOrmModule.forFeature([Contact])],
  providers: [ContactsService],
  controllers: [ContactsController],
})
export class ContactsModule {}
```

#### 5. Atualizar o Serviço Contacts

Atualize o serviço `ContactsService` para utilizar o repositório do TypeORM:

```typescript
// src/contacts/contacts.service.ts
import { Injectable } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { Contact } from './contacts.entity';

@Injectable()
export class ContactsService {
  constructor(
    @InjectRepository(Contact)
    private contactsRepository: Repository<Contact>,
  ) {}

  async findAll(): Promise<Contact[]> {
    return this.contactsRepository.find();
  }

  async findOne(id: number): Promise<Contact> {
    return this.contactsRepository.findOneBy({ id });
  }

  async create(contact: Partial<Contact>): Promise<Contact> {
    const newContact = this.contactsRepository.create(contact);
    return this.contactsRepository.save(newContact);
  }

  async update(id: number, contact: Partial<Contact>): Promise<Contact> {
    await this.contactsRepository.update(id, contact);
    return this.contactsRepository.findOneBy({ id });
  }

  async remove(id: number): Promise<void> {
    await this.contactsRepository.delete(id);
  }
}
```

#### 6. Atualizar o Controlador Contacts

Atualize o controlador `ContactsController` para manipular as requisições HTTP:

```typescript
// src/contacts/contacts.controller.ts
import { Controller, Get, Post, Body, Param, Delete } from '@nestjs/common';
import { ContactsService } from './contacts.service';
import { Contact } from './contacts.entity';

@Controller('contacts')
export class ContactsController {
  constructor(private readonly contactsService: ContactsService) {}

  @Get()
  findAll(): Promise<Contact[]> {
    return this.contactsService.findAll();
  }

  @Post()
  create(@Body() contact: Partial<Contact>): Promise<Contact> {
    return this.contactsService.create(contact);
  }

  @Get(':id')
  findOne(@Param('id') id: number): Promise<Contact> {
    return this.contactsService.findOne(id);
  }

  @Delete(':id')
  remove(@Param('id') id: number): Promise<void> {
    return this.contactsService.remove(id);
  }
}
```

## Testando a Aplicação

1. Inicie o servidor de desenvolvimento:

   ```bash
   npm run start:dev
   ```

2. Utilize o [Postman](https://www.postman.com/) para testar as seguintes rotas:

   - **GET** `http://localhost:3000/contacts` - Retorna todos os contatos.
   - **POST** `http://localhost:3000/contacts` - Cria um novo contato. Envie um corpo JSON com as propriedades `name`, `email`, `phone` e opcionalmente `birthDate`.
   - **GET** `http://localhost:3000/contacts/:id` - Retorna um contato específico pelo `id`.
   - **DELETE** `http://localhost:3000/contacts/:id` - Remove um contato pelo `id`.

## Exercício

Tente implementar a funcionalidade de atualização de dados. Adicione um novo método ao `ContactsService` para atualizar um contato existente e ajuste o `ContactsController` para lidar com a nova rota `PUT` para atualizar contatos.

## Referências

- [Documentação do Nest](https://docs.nestjs.com/)
- [Documentação do TypeORM](https://typeorm.io/)
